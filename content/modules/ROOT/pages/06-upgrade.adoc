= Upgrade the Hosted Cluster

The upgrade process for a hosted control planes cluster is a little different from that of standalone clusters, and so must be understood.
In this module you will explore the upgrade process, and then apply an upgrade to your cluster with configuration changes to the HostedCluster custom resource.

Fleet management is another of Red Hat Cluster Management for Kubernetes (RHACM) great strengths.
Upgrading clusters is a stanard operational process that responsible operators must master.

*Goals*

* Review upgrade processes for a hosted control planes cluster.
* Perform an upgrade to the cluster.

[[review-upgrade]]
== Review the Upgrade Process

. Log into your hosted cluster.
.. In the *All Clusters* panel, from the *Infrastrucutre -> Clusters* section, click *my-hosted-cluster*
select the *Console URL*.
+
image::upgrade/cluster_details.png[link=self, window=blank, width=100%]

. Log in with the `admin` administrative account using the password `openshift`.
+
image::upgrade/hosted_cluster_login.png[link=self, window=blank, width=100%]

. You are presented with the Administrator overview.
.. In the *Details* panel take notice of the *Update Channel*.
It is *Not available*.
No update channel has been defined.
+
image::upgrade/admin_overview.png[link=self, window=blank, width=50%]

. Go to the *Cluster Settings* page.
.. In the left-side menu click on *Administration -> Cluster Settings*.
.. Observe that the *Control plane is Hosted.*
.. Observe that the *Update status* confirms that no update channel is configured, and that you are not able to set the channel.
+
image::upgrade/update_channel.png[link=self, window=blank, width=100%]

. Return to the hosting cluster and understand the many ways to initiate the upgrade process.
.. Close the browser tab for the hosted cluster.
.. Return to the hosting cluster and the *Infrastructure -> Clusters -> my-hosted-cluster -> Cluster details* panel.

. For starters, there are two points to begin the upgrade process from the *Cluster details* panel
.. On the upper right, click *Actions* drop down menu and Uprade cluster is available here.
.. Scroll up the page to *Distribution version*, and you see another optional place to kick off the upgrade process.
+
image::upgrade/cluster_details_upgrade.png[link=self, window=blank, width=100%]

. There are two more ways to upgrade on the *Clusters -> Cluster list* tab.
.. Navigate to the very top of the clusters view and click *Clusters*.
.. On the *Cluster list* you find two more ways to update your cluster specifically
... In *Distribution version* column
... By clicking on the three-dot menu next to a particular cluster
+
image::upgrade/cluster_list_upgrade.png[link=self, window=blank, width=100%]

. You may also upgrade your fleet simultaneously.
.. If you selectt he check box next to each cluster to upgrade, you can select upgrade channels for each, and schedule them all to upgrade simultaneously, or at specific intervals.
+
image::upgrade/multi_cluster_upgrade.png[link=self, window=blank, width=100%]


[[apply-upgrade]]
== Apply the Cluster Upgrade

Now that you have explored the many methods that are available of how to begin your hosted cluster upgrade process, get started by performing one.

. Open the *Upgrade version* dialog box
.. Starting from the *Cluster list*, click on the hosted cluster *my-hosted-cluster*'s link for *Upgrade available*.
+
image::upgrade/upgrade_available.png[link=self, window=blank, width=100%]

. A new window appears with a drop-down menu allowing you to select from a number of acceptable release versions, from the latest z release of your current version, to the latest version of OpenShift available.
Our graphic here shows the latest version as 4.17.37, but in your drop down that may differ.
.. Select the latest version available, and click the blue *upgrade* button.
+
image::upgrade/upgrade_version.png[link=self, window=blank, width=100%]
+
NOTE: If you notice, it's quite possible to select an upgrade version for your hosted cluster that is greater than your hosting cluster. This option gives you maximum flexibility for your deployments.

WARNING: It can take several mintues before the upgrade process notifies the RHACM Console that the upgrade is progressing.

=== Cluster upgrade process

Here are the signs to look for that the upgrade is in progress.

. Identify signs that upgrade is progressing
.. In the *Cluseters -> my-hosted-cluster* panel you see "*Progressing* *Hosted cluster is deploying, upgrading, or reconfiguring."
+
image::upgrade/cluster_overview_progressing_upgrade.png[link=self, window=blank, width=100%]
+
.. In the *local-cluster* OpenShift console you can see the change in the configuration of the HostedCluster custom resource.
.. Navigate to *local-cluster* *Home -> API Explorer -> Filter by: HostedCluster -> HostedCluster -> Instances* and click on *my-hosted-cluster* and then click the *YAML* tab.
The target version will be in the *.spec.release.image* field.
+
image::upgrade/verify_target_version.png[link=self, window=blank, width=100%]
+
.. Node pools will also show the target version.
.. Navigate to *local-cluster* *Home -> API Explorer -> Filter by: nodepool -> NodePool -> Instances*, and click on *my-node-pool* and then the *YAML* tab.
The target version will be in the *.spec.release.image* field.
+
image::upgrade/node_pool_version_change.png[link=self, window=blank, width=100%]

. As the upgrade progresses you will continue to see live updates on *Control plane status* tile.
+
image::upgrade/control_plane_status_upgrading.png[link=self, window=blank, width=100%]

. You can also see the changes occuring on the hosted cluster, *my-hosted-cluster*.
.. Click the *Console URL* link.
.. On the left bar, click *Administration -> Cluster Settings*.
.. Observe that the *Update status* shows the upgrade is in progress.
+
image::upgrade/cluster_settings_update_status.png[link=self, window=blank, width=100%]

. Note how on the hosted cluster the style of the OpenShift Console will transform as it updates to version 4.19.
.. This is the new style of the OpenShift Console.
+
image::upgrade/console_transforms.png[link=self, window=blank, width=100%]

. The cluster upgrade process will be complete before the node pool upgrade process.
+
image::upgrade/control_plane_upgrade_complete.png[link=self, window=blank, width=100%]

=== Node pool upgrade process

. Now check on the node pool upgrades.
+
image::upgrade/node_pools_upgrading.png[link=self, window=blank, width=100%]

. Node pool upgrades take a bit longer, because virtual machines need to be replaced.
.. Click *Search -> Virtual Machines*.
+
image::upgrade/search_virtual_machines.png[link=self, window=blank, width=100%]

. There are now three virtual machines.
.. There will now be an extra virtual machine as the upgrade process starts up new versions of the nodes and shuts down the old ones.
+
image::upgrade/search_virtual_machines_upgrade.png[link=self, window=blank, width=100%]

. When the node pool upgrade is complete you will see the *Control plane status* update to show the current version.
+
image::upgrade/node_pool_upgrade_complete.png[link=self, window=blank, width=100%]

== Summary

In this module you explored how the upgrade process of an OpenShift on OpenShift with hosted control planes cluster differs from a standalone deployment.
After exploring your various upgrade options you kicked off an upgrade process to the latest version of OpenShift.

////
. A new tab will open and bring you to the Search section of your hosting Hub cluster where you can see the node details.
Even though this interface is on the hosting "Hub" cluster, the details in the Search interface are for the node on the *my-hosted-cluster*.
+
image::deploy/hosted_cluster_node_details.png[link=self, window=blank, width=100%]
////
